/**
 * Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° backend Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð¾Ð¼ ÑÐµÑ‚ÐµÐ²Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸
 * ÐŸÐ¾Ð»ÐµÐ·Ð½Ð¾ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°Ñ…
 */

const { spawn } = require('child_process');
const { getLocalIPAddress } = require('./get-local-ip');
const path = require('path');

// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ IP
const localIP = getLocalIPAddress();
const port = process.env.PORT || 3000;

console.log('\nðŸš€ Ð—Ð°Ð¿ÑƒÑÐº backend ÑÐµÑ€Ð²ÐµÑ€Ð° Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°Ñ…');
console.log('â•'.repeat(60));
console.log(`ðŸ“ Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ IP: ${localIP}`);
console.log(`ðŸ”Œ ÐŸÐ¾Ñ€Ñ‚: ${port}`);
console.log(`ðŸ“± API URL: http://${localIP}:${port}/api`);
console.log(`ðŸ”— WebSocket URL: ws://${localIP}:${port}`);
console.log('â•'.repeat(60));
console.log('\nðŸ’¡ Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° Ð² Ð¾Ð´Ð½Ð¾Ð¹ Wi-Fi ÑÐµÑ‚Ð¸!\n');

// Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€ Ñ‡ÐµÑ€ÐµÐ· nodemon Ð¸Ð»Ð¸ node
const isDev = process.argv.includes('--dev') || process.env.NODE_ENV === 'development';
const command = isDev ? 'nodemon' : 'node';
const serverPath = path.join(__dirname, '..', 'src', 'server.js');

const serverProcess = spawn(command, [serverPath], {
  stdio: 'inherit',
  shell: true,
  env: {
    ...process.env,
    PORT: port.toString()
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°
serverProcess.on('close', (code) => {
  console.log(`\n\nðŸ›‘ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ Ñ ÐºÐ¾Ð´Ð¾Ð¼ ${code}`);
  process.exit(code);
});

serverProcess.on('error', (error) => {
  console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°:', error);
  process.exit(1);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¸Ð³Ð½Ð°Ð»Ð¾Ð²
process.on('SIGINT', () => {
  console.log('\n\nðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ SIGINT, Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹...');
  serverProcess.kill('SIGINT');
});

process.on('SIGTERM', () => {
  console.log('\n\nðŸ›‘ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ SIGTERM, Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹...');
  serverProcess.kill('SIGTERM');
});

